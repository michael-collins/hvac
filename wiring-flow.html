<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>HVAC Wiring ‚Äî React Flow with Handles</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reactflow@11.11.4/dist/style.css">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=Archivo+Narrow:wght@600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="wiring-flow.css">
</head>
<body>
<div class="container">
  <h1>HVAC Wiring</h1>
  <p><a class="btn" href="index.html">Back</a></p>
  <div class="card">
    <h2>Full System Schematic</h2>
    <!-- <p class="note">Click to select nodes. Drag selected nodes to move them. Drag canvas to pan.</p> -->
    <div class="controls">
      <button id="exportBtn">üíæ Export Layout JSON</button>
      <button id="fitViewBtn">üîç Fit View</button>
      <button id="toggleEditBtn">‚úèÔ∏è Toggle Edit Mode</button>
      <button id="highlightPower">‚ö° Highlight Power Distribution</button>
      <button id="highlightCooling">‚ùÑÔ∏è Highlight Cooling Path</button>
      <button id="highlightHeating">üî• Highlight Heating Path</button>
      <button id="highlightDehumid">üíß Highlight Dehumidifier</button>
      <button id="resetBtn">üîÑ Reset Highlight</button>
    </div>
    <div style="display: flex; width: 100%; gap: 0;">
      <div id="root" style="flex: 1; min-width: 0;"></div>
      <div id="info-panel" style="width: 400px; height: 850px; background: var(--cb-bg-900); border-left: 2px solid var(--cb-ink-dim); overflow-y: auto; padding: 20px; display: none;">
        <div id="info-content"></div>
      </div>
    </div>
  </div>

  
</div>

<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/reactflow@11.11.4/dist/umd/index.min.js"></script>

<script>
// Get React utilities and ReactFlow components
const { useState, useCallback, createElement: h, Fragment } = React;
const { ReactFlow: RF, Controls, Background, MiniMap, Handle, Position, NodeToolbar, NodeResizer } = window.ReactFlow;

// Custom node component with multiple handles
const HVACNode = React.memo(({ data, selected }) => {
  const { label, nodeType, handles, zone } = data;
  
  return h('div', { 
    className: `hvac-node ${nodeType}`,
    style: { position: 'relative' }
  },
    // Render handles
    handles && handles.map((handle, idx) => {
      const labelPosition = handle.position === Position.Top ? 'bottom' : 
                           handle.position === Position.Bottom ? 'top' :
                           handle.position === Position.Left ? 'right' : 'left';
      const labelOffset = handle.position === Position.Top || handle.position === Position.Bottom ? 'left' : 'top';
      const labelStyle = {
        [labelPosition]: '100%',
        [labelOffset]: handle.style[labelOffset]
      };
      
      return h(Fragment, { key: handle.id },
        h(Handle, {
          type: handle.type,
          position: handle.position,
          id: handle.id,
          style: handle.style
        }),
        h('span', { 
          className: 'handle-label',
          style: labelStyle
        }, handle.label)
      );
    }),
    // Node label
    h('div', null, label),
    // Configuration button for panel node
    nodeType === 'panel' && h('button', {
      className: 'config-btn',
      onClick: (e) => {
        e.stopPropagation();
        window.showConfigPanel && window.showConfigPanel();
      }
    }, '‚öôÔ∏è Configuration'),
    // Menu button for thermostat nodes
    nodeType === 'thermostat' && h('button', {
      className: 'menu-btn',
      onClick: (e) => {
        e.stopPropagation();
        const rect = e.currentTarget.getBoundingClientRect();
        window.showThermostatMenu && window.showThermostatMenu(zone, rect.right + 10, rect.top);
      }
    }, '‚ò∞')
  );
});

const nodeTypes = {
  hvacNode: HVACNode
};

// Initial nodes with handles
const initialNodes = [
  {
    id: 'ups',
    type: 'hvacNode',
    position: { x: 328.7889728461288, y: 63.75746206538315 },
    data: { 
      label: 'UPS\n(120VAC Battery Backup)',
      nodeType: 'ups',
      handles: [
        { id: 'ac-out', type: 'source', position: Position.Right, label: '120VAC', style: { top: '50%', left: '100%' } }
      ]
    }
  },
  {
    id: 'panel',
    type: 'hvacNode',
    position: { x: 589.71, y: 200.89 },
    data: { 
      label: 'BMPLUS-3000\nZone Panel\n(Onboard Transformer)',
      nodeType: 'panel',
      handles: [
        // Left side - Damper controls (top to bottom)
        { id: 'z1m1-out', type: 'source', position: Position.Left, label: 'Z1-M1', style: { top: '8%' } },
        { id: 'z1m4-out', type: 'source', position: Position.Left, label: 'Z1-M4', style: { top: '12%' } },
        { id: 'z1m2-out', type: 'source', position: Position.Left, label: 'Z1-M2', style: { top: '16%' } },
        { id: 'z1m6-out', type: 'source', position: Position.Left, label: 'Z1-M6', style: { top: '20%' } },
        
        { id: 'z2m1-out', type: 'source', position: Position.Left, label: 'Z2-M1', style: { top: '28%' } },
        { id: 'z2m4-out', type: 'source', position: Position.Left, label: 'Z2-M4', style: { top: '32%' } },
        { id: 'z2m2-out', type: 'source', position: Position.Left, label: 'Z2-M2', style: { top: '36%' } },
        { id: 'z2m6-out', type: 'source', position: Position.Left, label: 'Z2-M6', style: { top: '40%' } },
        
        // Left side - Power terminals (middle section)
        { id: 'r-in', type: 'target', position: Position.Left, label: 'R', style: { top: '52%' } },
        { id: 'c-in', type: 'target', position: Position.Left, label: 'C', style: { top: '56%' } },
        
        // Left side - HVAC equipment outputs (bottom section)
        { id: 'g-out', type: 'source', position: Position.Left, label: 'G', style: { top: '64%' } },
        { id: 'y2-out', type: 'source', position: Position.Left, label: 'Y2', style: { top: '68%' } },
        { id: 'y1-out', type: 'source', position: Position.Left, label: 'Y1', style: { top: '72%' } },
        { id: 'o-out', type: 'source', position: Position.Left, label: 'O', style: { top: '76%' } },
        { id: 'w2-out', type: 'source', position: Position.Left, label: 'W2/E', style: { top: '84%' } },
        { id: 'w1-out', type: 'source', position: Position.Left, label: 'W1/B', style: { top: '88%' } },
        { id: 'rc-out', type: 'source', position: Position.Left, label: 'RC', style: { top: '92%' } },
        { id: 'c-relay', type: 'source', position: Position.Left, label: 'C', style: { top: '96%' } },
        
        // Right side - Zone 3 Thermostat (top)
        { id: 'z3-c-in', type: 'target', position: Position.Right, label: 'Z3: C', style: { top: '8%' } },
        { id: 'z3-we-in', type: 'target', position: Position.Right, label: 'Z3: W/E', style: { top: '12%' } },
        { id: 'z3-ob-in', type: 'target', position: Position.Right, label: 'Z3: O/B', style: { top: '16%' } },
        { id: 'z3-y-in', type: 'target', position: Position.Right, label: 'Z3: Y', style: { top: '20%' } },
        { id: 'z3-g-in', type: 'target', position: Position.Right, label: 'Z3: G', style: { top: '24%' } },
        { id: 'z3-r-in', type: 'target', position: Position.Right, label: 'Z3: R', style: { top: '28%' } },
        
        // Right side - Zone 2 Thermostat (middle)
        { id: 'z2-c', type: 'source', position: Position.Right, label: 'Z2: C', style: { top: '36%' } },
        { id: 'z2-we-in', type: 'target', position: Position.Right, label: 'Z2: W/E', style: { top: '40%' } },
        { id: 'z2-ob-in', type: 'target', position: Position.Right, label: 'Z2: O/B', style: { top: '44%' } },
        { id: 'z2-y-in', type: 'target', position: Position.Right, label: 'Z2: Y', style: { top: '48%' } },
        { id: 'z2-g-in', type: 'target', position: Position.Right, label: 'Z2: G', style: { top: '52%' } },
        { id: 'z2-r', type: 'source', position: Position.Right, label: 'Z2: R', style: { top: '56%' } },
        
        // Right side - Zone 1 Thermostat (bottom)
        { id: 'z1-c', type: 'source', position: Position.Right, label: 'Z1: C', style: { top: '64%' } },
        { id: 'z1-we-in', type: 'target', position: Position.Right, label: 'Z1: W/E', style: { top: '68%' } },
        { id: 'z1-ob-in', type: 'target', position: Position.Right, label: 'Z1: O/B', style: { top: '72%' } },
        { id: 'z1-y-in', type: 'target', position: Position.Right, label: 'Z1: Y', style: { top: '76%' } },
        { id: 'z1-g-in', type: 'target', position: Position.Right, label: 'Z1: G', style: { top: '80%' } },
        { id: 'z1-r', type: 'source', position: Position.Right, label: 'Z1: R', style: { top: '84%' } },
        
        // Top - Power input only
        { id: 'ac-in', type: 'target', position: Position.Top, label: '120VAC', style: { left: '50%' } }
      ]
    }
  },
  {
    id: 'ecobeeZ1',
    type: 'hvacNode',
    position: { x: 1225.4261884803095, y: 589.7896230895655 },
    data: { 
      label: 'Ecobee Z1\n(Enhanced)',
      nodeType: 'thermostat',
      zone: 'Z1',
      handles: [
        { id: 'r-in', type: 'target', position: Position.Top, label: 'R', style: { left: '5%' } },
        { id: 'c-in', type: 'target', position: Position.Top, label: 'C', style: { left: '95%' } },
        { id: 'g-out', type: 'source', position: Position.Top, label: 'G', style: { left: '30%' } },
        { id: 'y-out', type: 'source', position: Position.Top, label: 'Y', style: { left: '45%' } },
        { id: 'ob-out', type: 'source', position: Position.Top, label: 'O/B', style: { left: '60%' } },
        { id: 'we-out', type: 'source', position: Position.Top, label: 'W/E', style: { left: '75%' } }
      ]
    }
  },
  {
    id: 'ecobeeZ2',
    type: 'hvacNode',
    position: { x: 1479.655436596535, y: 731.3086084835709 },
    data: { 
      label: 'Ecobee Z2\n(Premium)',
      nodeType: 'thermostat',
      zone: 'Z2',
      handles: [
        { id: 'acc-out', type: 'source', position: Position.Top, label: 'ACC+', style: { left: '5%' } },
        { id: 'r-in', type: 'target', position: Position.Top, label: 'R', style: { left: '20%' } },
        { id: 'g-out', type: 'source', position: Position.Top, label: 'G', style: { left: '35%' } },
        { id: 'y-out', type: 'source', position: Position.Top, label: 'Y', style: { left: '50%' } },
        { id: 'ob-out', type: 'source', position: Position.Top, label: 'O/B', style: { left: '65%' } },
        { id: 'we-out', type: 'source', position: Position.Top, label: 'W/E', style: { left: '80%' } },
        { id: 'c-in', type: 'target', position: Position.Top, label: 'C', style: { left: '95%' } }
      ]
    }
  },
  {
    id: 'relay',
    type: 'hvacNode',
    position: { x: 713.2240400165607, y: 745.7637926204724 },
    data: { 
      label: 'RIBU1C\nRelay',
      nodeType: 'relay',
      handles: [
        { id: 'coil-plus', type: 'target', position: Position.Top, label: 'Coil+', style: { left: '65%' } },
        { id: 'coil-minus', type: 'target', position: Position.Top, label: 'Coil-', style: { left: '35%' } },
        { id: 'no-out', type: 'source', position: Position.Right, label: 'NO', style: { top: '35%' } },
        { id: 'com-out', type: 'source', position: Position.Right, label: 'COM', style: { top: '65%' } }
      ]
    }
  },
  {
    id: 'dehumidifier',
    type: 'hvacNode',
    position: { x: 1130.467684800582, y: 743.912234338264 },
    data: { 
      label: 'GeneralAire\nDehumidifier',
      nodeType: 'dehumidifier',
      handles: [
        { id: 'd1-in', type: 'target', position: Position.Left, label: 'D1', style: { top: '35%' } },
        { id: 'd2-in', type: 'target', position: Position.Left, label: 'D2', style: { top: '65%' } }
      ]
    }
  },
  {
    id: 'damper1',
    type: 'hvacNode',
    position: { x: 13.642908442547053, y: 353.12161968611264 },
    data: { 
      label: 'Zone 1 Damper\n(First Floor)',
      nodeType: 'damper',
      handles: [
        { id: 'm1-in', type: 'target', position: Position.Top, label: 'M1', style: { left: '25%' } },
        { id: 'm4-in', type: 'target', position: Position.Top, label: 'M4', style: { left: '50%' } },
        { id: 'm6-in', type: 'target', position: Position.Top, label: 'M6', style: { left: '75%' } }
      ]
    }
  },
  {
    id: 'damper2',
    type: 'hvacNode',
    position: { x: 278.04369325153374, y: 353.416380368098 },
    data: { 
      label: 'Zone 2 Damper\n(Basement)',
      nodeType: 'damper',
      handles: [
        { id: 'm1-in', type: 'target', position: Position.Top, label: 'M1', style: { left: '35%' } },
        { id: 'm4-in', type: 'target', position: Position.Top, label: 'M4', style: { left: '65%' } }
      ]
    }
  },
  {
    id: 'equipment',
    type: 'hvacNode',
    position: { x: 132.75628495964014, y: 602.3027501205024 },
    data: { 
      label: 'HVAC Equipment\n(Rheem RP14 + Aux)',
      nodeType: 'equipment',
      handles: [
        { id: 'g-in', type: 'target', position: Position.Top, label: 'G', style: { left: '15%' } },
        { id: 'y1-in', type: 'target', position: Position.Top, label: 'Y1', style: { left: '30%' } },
        { id: 'o-in', type: 'target', position: Position.Top, label: 'O', style: { left: '50%' } },
        { id: 'w2-in', type: 'target', position: Position.Top, label: 'W2', style: { left: '70%' } },
        { id: 'w1-in', type: 'target', position: Position.Top, label: 'W1', style: { left: '85%' } }
      ]
    }
  }
];

// Edge colors
const edgeColors = {
  ac: '#9bb0d6',
  hot: '#7aa2ff',
  common: '#6ee7a1',
  signal: '#fcd34d',
  'dry-contact': '#6ee7a1',
  damper: '#fca5a5'
};

// Initial edges with specific handle connections
const initialEdges = [
  // UPS to Panel (120VAC)
  { id: 'e1', source: 'ups', sourceHandle: 'ac-out', target: 'panel', targetHandle: 'ac-in', type: 'smoothstep', style: { stroke: edgeColors.ac, strokeWidth: 4 } },
  
  // Panel to Thermostats (24VAC power from onboard transformer) - R and C from zone terminal blocks
  { id: 'e2', source: 'panel', sourceHandle: 'z1-r', target: 'ecobeeZ1', targetHandle: 'r-in', type: 'smoothstep', style: { stroke: edgeColors.hot, strokeWidth: 2.5 } },
  { id: 'e3', source: 'panel', sourceHandle: 'z1-c', target: 'ecobeeZ1', targetHandle: 'c-in', type: 'smoothstep', style: { stroke: edgeColors.common, strokeWidth: 2.5 } },
  { id: 'e4', source: 'panel', sourceHandle: 'z2-r', target: 'ecobeeZ2', targetHandle: 'r-in', type: 'smoothstep', style: { stroke: edgeColors.hot, strokeWidth: 2.5 } },
  { id: 'e5', source: 'panel', sourceHandle: 'z2-c', target: 'ecobeeZ2', targetHandle: 'c-in', type: 'smoothstep', style: { stroke: edgeColors.common, strokeWidth: 2.5 } },
  
  // Zone 1 Ecobee control wires to panel (right side zone terminal block)
  { id: 'e7a', source: 'ecobeeZ1', sourceHandle: 'g-out', target: 'panel', targetHandle: 'z1-g-in', type: 'smoothstep', style: { stroke: edgeColors.signal, strokeWidth: 2.5 } },
  { id: 'e8', source: 'ecobeeZ1', sourceHandle: 'y-out', target: 'panel', targetHandle: 'z1-y-in', type: 'smoothstep', style: { stroke: edgeColors.signal, strokeWidth: 2.5 } },
  { id: 'e8a', source: 'ecobeeZ1', sourceHandle: 'ob-out', target: 'panel', targetHandle: 'z1-ob-in', type: 'smoothstep', style: { stroke: edgeColors.signal, strokeWidth: 2.5 } },
  { id: 'e8b', source: 'ecobeeZ1', sourceHandle: 'we-out', target: 'panel', targetHandle: 'z1-we-in', type: 'smoothstep', style: { stroke: edgeColors.signal, strokeWidth: 2.5 } },
  
  // Zone 2 Ecobee calls to panel (right side of panel)
  { id: 'e9a', source: 'ecobeeZ2', sourceHandle: 'g-out', target: 'panel', targetHandle: 'z2-g-in', type: 'smoothstep', style: { stroke: edgeColors.signal, strokeWidth: 2.5 } },
  { id: 'e10', source: 'ecobeeZ2', sourceHandle: 'y-out', target: 'panel', targetHandle: 'z2-y-in', type: 'smoothstep', style: { stroke: edgeColors.signal, strokeWidth: 2.5 } },
  { id: 'e10a', source: 'ecobeeZ2', sourceHandle: 'ob-out', target: 'panel', targetHandle: 'z2-ob-in', type: 'smoothstep', style: { stroke: edgeColors.signal, strokeWidth: 2.5 } },
  { id: 'e10b', source: 'ecobeeZ2', sourceHandle: 'we-out', target: 'panel', targetHandle: 'z2-we-in', type: 'smoothstep', style: { stroke: edgeColors.signal, strokeWidth: 2.5 } },
  
  // Panel to equipment (left side of panel)
  { id: 'e11', source: 'panel', sourceHandle: 'y1-out', target: 'equipment', targetHandle: 'y1-in', type: 'smoothstep', style: { stroke: edgeColors.signal, strokeWidth: 2.5 } },
  { id: 'e12', source: 'panel', sourceHandle: 'w1-out', target: 'equipment', targetHandle: 'w1-in', type: 'smoothstep', style: { stroke: edgeColors.signal, strokeWidth: 2.5 } },
  { id: 'e12a', source: 'panel', sourceHandle: 'w2-out', target: 'equipment', targetHandle: 'w2-in', type: 'smoothstep', style: { stroke: edgeColors.signal, strokeWidth: 2.5 } },
  { id: 'e13', source: 'panel', sourceHandle: 'g-out', target: 'equipment', targetHandle: 'g-in', type: 'smoothstep', style: { stroke: edgeColors.signal, strokeWidth: 2.5 } },
  { id: 'e14', source: 'panel', sourceHandle: 'o-out', target: 'equipment', targetHandle: 'o-in', type: 'smoothstep', style: { stroke: edgeColors.signal, strokeWidth: 2.5 } },
  
  // Dehumidify path
  { id: 'e15', source: 'ecobeeZ2', sourceHandle: 'acc-out', target: 'relay', targetHandle: 'coil-plus', type: 'smoothstep', style: { stroke: edgeColors.signal, strokeWidth: 2.5 } },
  { id: 'e16', source: 'panel', sourceHandle: 'c-relay', target: 'relay', targetHandle: 'coil-minus', type: 'smoothstep', style: { stroke: edgeColors.common, strokeWidth: 2.5 } },
  { id: 'e17', source: 'relay', sourceHandle: 'no-out', target: 'dehumidifier', targetHandle: 'd1-in', type: 'smoothstep', style: { stroke: edgeColors['dry-contact'], strokeWidth: 2.5, strokeDasharray: '5,5' } },
  { id: 'e18', source: 'relay', sourceHandle: 'com-out', target: 'dehumidifier', targetHandle: 'd2-in', type: 'smoothstep', style: { stroke: edgeColors['dry-contact'], strokeWidth: 2.5, strokeDasharray: '5,5' } },
  
  // Zone damper control (left side of panel)
  { id: 'e19', source: 'panel', sourceHandle: 'z1m1-out', target: 'damper1', targetHandle: 'm1-in', type: 'smoothstep', style: { stroke: edgeColors.damper, strokeWidth: 2.5 } },
  { id: 'e20', source: 'panel', sourceHandle: 'z1m4-out', target: 'damper1', targetHandle: 'm4-in', type: 'smoothstep', style: { stroke: edgeColors.damper, strokeWidth: 2.5 } },
  { id: 'e21', source: 'panel', sourceHandle: 'z1m6-out', target: 'damper1', targetHandle: 'm6-in', type: 'smoothstep', style: { stroke: edgeColors.damper, strokeWidth: 2.5 } },
  { id: 'e22', source: 'panel', sourceHandle: 'z2m1-out', target: 'damper2', targetHandle: 'm1-in', type: 'smoothstep', style: { stroke: edgeColors.damper, strokeWidth: 2.5 } },
  { id: 'e23', source: 'panel', sourceHandle: 'z2m4-out', target: 'damper2', targetHandle: 'm4-in', type: 'smoothstep', style: { stroke: edgeColors.damper, strokeWidth: 2.5 } }
];

function Flow() {
  const [nodes, setNodes] = useState(window.currentNodes || initialNodes);
  const [edges, setEdges] = useState(window.currentEdges || initialEdges);
  const [rfInstance, setRfInstance] = useState(null);
  const [contextMenu, setContextMenu] = useState(null);
  const [isEditMode, setIsEditMode] = useState(false);

  // Expose setEdges and setNodes globally for highlight functions
  window.flowSetEdges = setEdges;
  window.flowSetNodes = setNodes;
  
  // Expose edit mode toggle
  window.toggleEditMode = () => {
    setIsEditMode(prev => !prev);
  };

  const onNodesChange = useCallback((changes) => {
    // Filter out dimension changes that cause visibility toggling
    const filteredChanges = changes.filter(change => 
      change.type !== 'dimensions'
    );
    
    if (filteredChanges.length === 0) return;
    
    setNodes((nds) => {
      const updated = [...nds];
      filteredChanges.forEach(change => {
        if (change.type === 'position' && change.position) {
          const node = updated.find(n => n.id === change.id);
          if (node) node.position = change.position;
        }
        if (change.type === 'remove') {
          const idx = updated.findIndex(n => n.id === change.id);
          if (idx > -1) updated.splice(idx, 1);
        }
        if (change.type === 'select') {
          const node = updated.find(n => n.id === change.id);
          if (node) {
            node.selected = change.selected;
          }
        }
      });
      window.currentNodes = updated;
      return updated;
    });
  }, []);

  const onEdgesChange = useCallback((changes) => {
    // Only update edges if there are actual changes that matter
    const hasRelevantChanges = changes.some(change => 
      change.type === 'remove' || change.type === 'add' || change.type === 'reset'
    );
    if (hasRelevantChanges) {
      setEdges(eds => [...eds]);
    }
  }, []);

  const onNodeContextMenu = useCallback((event, node) => {
    event.preventDefault();
    
    // Only show context menu for Ecobee thermostats
    if (node.id === 'ecobeeZ1' || node.id === 'ecobeeZ2') {
      const zone = node.data.zone;
      
      // Get mouse position relative to the viewport
      const bounds = event.currentTarget.getBoundingClientRect();
      const x = event.clientX;
      const y = event.clientY;
      
      setContextMenu({
        x: x + 10, // Slight offset from cursor
        y: y + 10,
        zone: zone
      });
    }
  }, []);

  const onPaneClick = useCallback(() => {
    setContextMenu(null);
  }, []);

  const onInit = useCallback((instance) => {
    setRfInstance(instance);
    window.rfInstance = instance;
    // Delay fitView to allow nodes to render first
    setTimeout(() => instance.fitView({ padding: 0.2, duration: 200 }), 50);
  }, []);

  // Expose function to show thermostat menu
  window.showThermostatMenu = (zone, x, y) => {
    setContextMenu({ zone, x, y });
  };

  return h(RF, {
    nodes,
    edges,
    onNodesChange,
    onEdgesChange,
    onPaneClick,
    onNodeContextMenu,
    onInit,
    nodeTypes,
    fitView: false,
    minZoom: 0.2,
    maxZoom: 2,
    nodesDraggable: isEditMode,
    nodesConnectable: false,
    elementsSelectable: true,
    proOptions: { hideAttribution: true },
    defaultEdgeOptions: {
      type: 'smoothstep'
    }
  },
    h(Controls),
    h(Background, { color: '#223', gap: 16 }),
    // Context menu
    contextMenu && h('div', {
      className: 'context-menu',
      style: {
        position: 'fixed',
        left: `${contextMenu.x}px`,
        top: `${contextMenu.y}px`
      },
      onMouseDown: (e) => e.stopPropagation()
    },
      h('button', { onClick: () => { window.callHeat(contextMenu.zone); setContextMenu(null); } }, `üî• Heat`),
      h('button', { onClick: () => { window.callAuxHeat(contextMenu.zone); setContextMenu(null); } }, `‚ö° Aux`),
      h('button', { onClick: () => { window.callCool(contextMenu.zone); setContextMenu(null); } }, `‚ùÑÔ∏è Cool`),
      h('button', { 
        onClick: () => { window.callDehumidify(contextMenu.zone); setContextMenu(null); },
        disabled: contextMenu.zone !== 'Z2'
      }, `üíß Dehumid`)
    )
  );
}

// Setup export function (outside setTimeout so it's globally available)
const exportLayout = () => {
  const layout = {
    nodes: window.currentNodes || [],
    edges: window.currentEdges || []
  };
  
  const json = JSON.stringify(layout, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'hvac-reactflow-layout.json';
  a.click();
  URL.revokeObjectURL(url);
  
  console.log("=== React Flow Layout ===");
  console.log(json);
  alert("Layout exported! Check downloads and console.");
};

window.exportLayout = exportLayout;

// Setup event handlers and render
document.getElementById('exportBtn').addEventListener('click', exportLayout);
document.getElementById('fitViewBtn').addEventListener('click', () => {
  if (window.rfInstance) window.rfInstance.fitView({ padding: 0.2 });
});

// System information data
const systemInfo = {
  heat: {
    title: 'üî• Heating ‚Äì Heat Pump Mode',
    content: `
<p><strong>Trigger:</strong> Either Ecobee calls for heat when outdoor conditions are above your Ecobee's balance-point temperature.</p>
<p><strong>Signals:</strong> Ecobee ‚Üí Y1 (compressor), O (reversing valve = heat), G (fan).</p>

<h3>Sequence</h3>
<ol>
  <li>Ecobee issues heat call.</li>
  <li>BMPLUS-3000:
    <ul>
      <li>Opens the calling zone's damper(s).</li>
      <li>Closes all other dampers.</li>
      <li>Sends Y1 + O + G to the heat pump / air handler.</li>
    </ul>
  </li>
  <li>Heat pump energizes in heating mode.</li>
  <li>Blower starts immediately (some units have a 5‚Äì10 s delay).</li>
  <li>When the thermostat is satisfied:
    <ul>
      <li>Ecobee drops Y1; BMPLUS stops the call; blower runs ~90 s post-purge.</li>
      <li>Dampers return to neutral / standby.</li>
    </ul>
  </li>
</ol>

<h3>Normal Delays & Protections</h3>
<ul>
  <li><strong>Compressor short-cycle delay:</strong> 5 min built-in at the heat pump and sometimes in Ecobee.</li>
  <li><strong>Zone panel call overlap delay:</strong> ~30 s stagger to prevent simultaneous zone calls.</li>
  <li><strong>Fan off-delay:</strong> 60‚Äì90 s to clear coil heat.</li>
</ul>
    `
  },
  cool: {
    title: '‚ùÑÔ∏è Cooling ‚Äì Heat Pump Mode',
    content: `
<p><strong>Trigger:</strong> Either Ecobee calls for cooling (indoor temp > setpoint).</p>
<p><strong>Signals:</strong> Ecobee ‚Üí Y1 (compressor), O (reversing valve = cool), G (fan).</p>

<h3>Sequence</h3>
<ol>
  <li>Ecobee calls for cooling.</li>
  <li>BMPLUS opens the calling zone's damper(s), closes others.</li>
  <li>Sends Y1 + O + G to the outdoor unit.</li>
  <li>Heat pump runs in cooling mode.</li>
  <li>Blower runs immediately.</li>
  <li>When satisfied:
    <ul>
      <li>Ecobee drops Y1; BMPLUS releases the call.</li>
      <li>Blower continues 60‚Äì90 s post-cool-off.</li>
      <li>Dampers normalize.</li>
    </ul>
  </li>
</ol>

<h3>Normal Delays & Protections</h3>
<ul>
  <li><strong>Compressor anti-short-cycle:</strong> 5 min typical.</li>
  <li><strong>Condensate / coil defrost safety:</strong> BMPLUS ignores brief drops in thermostat signal.</li>
  <li><strong>Zone coordination delay:</strong> ~30 s between zone calls.</li>
</ul>
    `
  },
  aux: {
    title: 'üî• Auxiliary Heat ‚Äì Propane Furnace (Dual Fuel)',
    content: `
<p><strong>Trigger:</strong></p>
<ul>
  <li>Ecobee decides outdoor temperature is below your Compressor Lockout or Aux Lock-in setpoint.</li>
  <li>Or the heat pump ran too long without reaching setpoint.</li>
</ul>
<p><strong>Signals:</strong> Ecobee ‚Üí W1 (heat call) only ‚Äî no Y1/O.</p>

<h3>Sequence</h3>
<ol>
  <li>Ecobee disables the compressor and energizes W1.</li>
  <li>BMPLUS-3000 forwards W1 to the furnace control board.</li>
  <li>Furnace:
    <ul>
      <li>Begins its ignition sequence (~30 s pre-purge, ignition, flame establish).</li>
      <li>Controls its own blower delay (typically 30‚Äì45 s after burner ignition).</li>
    </ul>
  </li>
  <li>When satisfied:
    <ul>
      <li>Ecobee drops W1.</li>
      <li>Furnace shuts gas, runs post-purge fan (60‚Äì90 s).</li>
      <li>BMPLUS opens/closes dampers back to normal.</li>
    </ul>
  </li>
</ol>

<h3>Normal Delays & Protections</h3>
<ul>
  <li><strong>Compressor lockout:</strong> Ensures no simultaneous HP + furnace run.</li>
  <li><strong>Furnace time-based fan control:</strong> The BMPLUS lets the furnace handle blower timing.</li>
  <li><strong>Short-cycle prevention:</strong> Ecobee minimum on/off times (default 5 min).</li>
</ul>
    `
  },
  dehumidify: {
    title: 'üíß Dehumidify ‚Äì Basement Zone Only',
    content: `
<p><strong>Trigger:</strong> Zone 2 Ecobee detects humidity above setpoint (e.g., > 50%).</p>
<p><strong>Signals:</strong> Ecobee ACC+ ‚Üí relay coil ‚Üí GeneralAire D1‚ÄìD2 closed.</p>

<h3>Sequence</h3>
<ol>
  <li>Ecobee sends 24 VAC on ACC+.</li>
  <li>Relay (RIBU1C) energizes:
    <ul>
      <li>Closes D1‚ÄìD2 on GeneralAire ‚Üí dehumidifier runs.</li>
      <li>Forces Zone 2 damper OPEN (M1‚ÜíM6).</li>
      <li>Forces Zone 1 damper CLOSED (M1‚ÜíM4).</li>
    </ul>
  </li>
  <li>BMPLUS fan output energizes blower at low speed (G signal).</li>
  <li>Dehumidifier pulls air from the return; exhausts dry air back into the same plenum.</li>
  <li>When humidity is satisfied:
    <ul>
      <li>Ecobee drops ACC+; relay de-energizes; D1‚ÄìD2 open ‚Üí dehumidifier stops.</li>
      <li>Dampers revert to normal zone control.</li>
      <li>Blower runs its fan-off delay (30‚Äì60 s).</li>
    </ul>
  </li>
</ol>

<h3>Normal Delays & Protections</h3>
<ul>
  <li><strong>Hysteresis:</strong> Ecobee waits ~2 % RH below setpoint before dropping call (prevents short cycling).</li>
  <li><strong>Fan During Dehumidify:</strong> Set to OFF so blower runs only when the relay is active.</li>
  <li><strong>Lockout:</strong> Dehumidifier will not run during compressor defrost or aux-heat mode.</li>
  <li><strong>Minimum off-time:</strong> Usually 3 min internal to GeneralAire.</li>
</ul>
    `
  }
};

function showInfoPanel(mode) {
  const panel = document.getElementById('info-panel');
  const content = document.getElementById('info-content');
  
  if (mode && systemInfo[mode]) {
    content.innerHTML = `
      <h2 style="margin-top: 0; color: var(--cb-ink); font-family: 'Archivo Narrow', sans-serif; font-size: 1.5rem; margin-bottom: 1rem;">
        ${systemInfo[mode].title}
      </h2>
      <div style="color: var(--cb-ink); line-height: 1.6;">
        ${systemInfo[mode].content}
      </div>
    `;
    panel.style.display = 'block';
  } else {
    panel.style.display = 'none';
  }
}

function showConfigPanel() {
  const panel = document.getElementById('info-panel');
  const content = document.getElementById('info-content');
  
  content.innerHTML = `
    <h2 style="margin-top: 0; color: var(--cb-ink); font-family: 'Archivo Narrow', sans-serif; font-size: 1.5rem; margin-bottom: 1rem;">
      ‚öôÔ∏è BMPLUS-3000 Configuration
    </h2>
    <div style="color: var(--cb-ink); line-height: 1.6;">
      
      <h3>DIP Switches</h3>
      <table style="width: 100%; border-collapse: collapse; margin: 1rem 0;">
        <thead>
          <tr style="border-bottom: 2px solid var(--cb-grid);">
            <th style="text-align: left; padding: 0.5rem; color: var(--cb-ink);">Switch</th>
            <th style="text-align: left; padding: 0.5rem; color: var(--cb-ink);">Position</th>
            <th style="text-align: left; padding: 0.5rem; color: var(--cb-ink);">Notes</th>
          </tr>
        </thead>
        <tbody>
          <tr style="border-bottom: 1px solid var(--cb-grid);">
            <td style="padding: 0.5rem; font-weight: 600;">SW1 ‚Äì System Type</td>
            <td style="padding: 0.5rem; color: var(--cb-alert);">HP (ON)</td>
            <td style="padding: 0.5rem;">For heat pump operation</td>
          </tr>
          <tr style="border-bottom: 1px solid var(--cb-grid);">
            <td style="padding: 0.5rem; font-weight: 600;">SW2 ‚Äì Reversing Valve</td>
            <td style="padding: 0.5rem; color: var(--cb-alert);">O</td>
            <td style="padding: 0.5rem;">Energize in cool</td>
          </tr>
          <tr style="border-bottom: 1px solid var(--cb-grid);">
            <td style="padding: 0.5rem; font-weight: 600;">SW3 ‚Äì Dual Fuel Control</td>
            <td style="padding: 0.5rem; color: var(--cb-alert);">OFF</td>
            <td style="padding: 0.5rem;">Ecobee handles balance</td>
          </tr>
          <tr style="border-bottom: 1px solid var(--cb-grid);">
            <td style="padding: 0.5rem; font-weight: 600;">SW4 ‚Äì Fan in Heat</td>
            <td style="padding: 0.5rem; color: var(--cb-alert);">HVAC</td>
            <td style="padding: 0.5rem;">Furnace controls blower</td>
          </tr>
          <tr style="border-bottom: 1px solid var(--cb-grid);">
            <td style="padding: 0.5rem; font-weight: 600;">SW5 ‚Äì 2-Stage Compressor</td>
            <td style="padding: 0.5rem; color: var(--cb-alert);">OFF</td>
            <td style="padding: 0.5rem;">Single-stage system</td>
          </tr>
          <tr style="border-bottom: 1px solid var(--cb-grid);">
            <td style="padding: 0.5rem; font-weight: 600;">SW6 ‚Äì Purge</td>
            <td style="padding: 0.5rem; color: var(--cb-alert);">ON</td>
            <td style="padding: 0.5rem;">60‚Äì90 s post-run fan</td>
          </tr>
          <tr style="border-bottom: 1px solid var(--cb-grid);">
            <td style="padding: 0.5rem; font-weight: 600;">SW7 ‚Äì Zones</td>
            <td style="padding: 0.5rem; color: var(--cb-alert);">2</td>
            <td style="padding: 0.5rem;">Two-zone configuration</td>
          </tr>
          <tr style="border-bottom: 1px solid var(--cb-grid);">
            <td style="padding: 0.5rem; font-weight: 600;">SW8 ‚Äì Stage Delay</td>
            <td style="padding: 0.5rem; color: var(--cb-alert);">OFF</td>
            <td style="padding: 0.5rem;">Let Ecobee manage</td>
          </tr>
          <tr style="border-bottom: 1px solid var(--cb-grid);">
            <td style="padding: 0.5rem; font-weight: 600;">SW9 ‚Äì Aux Heat Type</td>
            <td style="padding: 0.5rem; color: var(--cb-alert);">GAS</td>
            <td style="padding: 0.5rem;">Propane furnace</td>
          </tr>
          <tr>
            <td style="padding: 0.5rem; font-weight: 600;">SW10 ‚Äì Continuous Fan</td>
            <td style="padding: 0.5rem; color: var(--cb-alert);">OFF</td>
            <td style="padding: 0.5rem;">Ecobee manages circulation</td>
          </tr>
        </tbody>
      </table>

      <h3 style="margin-top: 2rem;">Potentiometer Settings</h3>
      
      <table style="width: 100%; border-collapse: collapse; margin: 1rem 0;">
        <thead>
          <tr style="border-bottom: 2px solid var(--cb-grid);">
            <th style="text-align: left; padding: 0.5rem; color: var(--cb-ink);">Potentiometer</th>
            <th style="text-align: left; padding: 0.5rem; color: var(--cb-ink);">Scale Range</th>
            <th style="text-align: left; padding: 0.5rem; color: var(--cb-ink);">Function</th>
            <th style="text-align: left; padding: 0.5rem; color: var(--cb-ink);">Recommended Setting</th>
            <th style="text-align: left; padding: 0.5rem; color: var(--cb-ink);">Reason</th>
          </tr>
        </thead>
        <tbody>
          <tr style="border-bottom: 1px solid var(--cb-grid);">
            <td style="padding: 0.5rem; font-weight: 600;">POT 1</td>
            <td style="padding: 0.5rem; font-family: monospace; font-size: 0.75rem;">OFF, 7, 14, 21, 28, 35, 42</td>
            <td style="padding: 0.5rem;">Staging timer (minutes before AUX)</td>
            <td style="padding: 0.5rem; color: var(--cb-alert); font-weight: 600;">42 (max)</td>
            <td style="padding: 0.5rem;">Disables BMPLUS staging - Ecobee controls</td>
          </tr>
          <tr style="border-bottom: 1px solid var(--cb-grid);">
            <td style="padding: 0.5rem; font-weight: 600;">POT 2</td>
            <td style="padding: 0.5rem; font-family: monospace; font-size: 0.75rem;">34, 37, 40, 43, 46, 49, 52</td>
            <td style="padding: 0.5rem;">Low temp limit (¬∞F) - Compressor lockout</td>
            <td style="padding: 0.5rem; color: var(--cb-alert); font-weight: 600;">34 (min)</td>
            <td style="padding: 0.5rem;">Ecobee decides balance point via internet weather</td>
          </tr>
          <tr style="border-bottom: 1px solid var(--cb-grid);">
            <td style="padding: 0.5rem; font-weight: 600;">POT 3</td>
            <td style="padding: 0.5rem; font-family: monospace; font-size: 0.75rem;">110, 120, 130, 140, 150, 160, 170</td>
            <td style="padding: 0.5rem;">High temp limit (¬∞F) - Compressor re-enable</td>
            <td style="padding: 0.5rem; color: var(--cb-alert); font-weight: 600;">170 (max)</td>
            <td style="padding: 0.5rem;">Prevents premature lockout</td>
          </tr>
          <tr>
            <td style="padding: 0.5rem; font-weight: 600;">POT 4</td>
            <td style="padding: 0.5rem; font-family: monospace; font-size: 0.75rem;">5, 12, 19, 26, 33, 40, 47</td>
            <td style="padding: 0.5rem;">2nd stage differential (¬∞F drop before AUX)</td>
            <td style="padding: 0.5rem; color: var(--cb-alert); font-weight: 600;">47 (max)</td>
            <td style="padding: 0.5rem;">Avoids redundant staging - Ecobee controls</td>
          </tr>
        </tbody>
      </table>

      <div style="margin: 1.5rem 0; padding: 1rem; background: rgba(205, 39, 48, 0.1); border-left: 3px solid var(--cb-alert);">
        <h4 style="margin: 0 0 0.5rem 0; color: var(--cb-alert);">‚ö†Ô∏è WiFi Backup Configuration</h4>
        <p style="margin: 0.5rem 0; font-size: 0.9rem;">Since your Ecobee uses internet weather data (no outdoor sensor), consider these backup settings if WiFi reliability is a concern:</p>
        <ul style="margin: 0.5rem 0; padding-left: 1.5rem; font-size: 0.88rem;">
          <li style="margin: 0.5rem 0;"><strong>POT 1:</strong> Set to 14-21 minutes ‚Äî BMPLUS will stage to AUX if heat pump runs too long without satisfying</li>
          <li style="margin: 0.5rem 0;"><strong>POT 2:</strong> Consider adding outdoor air sensor to BMPLUS OAS terminals, then set to your balance point (e.g., 40¬∞F)</li>
          <li style="margin: 0.5rem 0;"><strong>POT 4:</strong> Set to 5-12¬∞F ‚Äî BMPLUS stages to AUX if indoor temp drops significantly below setpoint</li>
        </ul>
        <p style="margin: 0.5rem 0; font-size: 0.85rem; font-style: italic;">Without an outdoor sensor on BMPLUS, POT 2 won't provide compressor lockout protection during WiFi outages.</p>
      </div>
      
    </div>
  `;
  panel.style.display = 'block';
}

window.showConfigPanel = showConfigPanel;

// Highlight path functions
function highlightCustomPath(edgeIds, description, infoMode) {
  const highlightEdgeIds = new Set(edgeIds);
  const highlightNodeIds = new Set();
  
  // Find all nodes involved in the highlighted edges
  initialEdges.forEach(edge => {
    if (highlightEdgeIds.has(edge.id)) {
      highlightNodeIds.add(edge.source);
      highlightNodeIds.add(edge.target);
    }
  });
  
  // Update edges styling
  const updatedEdges = initialEdges.map(edge => ({
    ...edge,
    style: {
      ...edge.style,
      strokeWidth: highlightEdgeIds.has(edge.id) ? 4 : 2,
      opacity: highlightEdgeIds.has(edge.id) ? 1 : 0.2
    },
    animated: highlightEdgeIds.has(edge.id)
  }));
  
  // Update nodes styling - preserve positions and data
  const updatedNodes = (window.currentNodes || initialNodes).map(node => ({
    ...node,
    data: { ...node.data },
    style: highlightNodeIds.has(node.id) ? { opacity: 1 } : { opacity: 0.3 }
  }));
  
  // Update state instead of re-rendering
  if (window.flowSetEdges && window.flowSetNodes) {
    window.flowSetEdges(updatedEdges);
    window.flowSetNodes(updatedNodes);
  }
  
  window.currentEdges = updatedEdges;
  window.currentNodes = updatedNodes;
  
  if (infoMode) {
    showInfoPanel(infoMode);
  }
  
  if (description) {
    console.log(`Highlighted: ${description}`);
  }
}

// Global functions accessible from toolbar buttons
window.callHeat = (zone) => {
  const heatingEdges = zone === 'Z1' 
    ? ['e1', 'e2', 'e3', 'e7a', 'e8a', 'e8b', 'e12', 'e13', 'e19', 'e20', 'e21'] 
    : ['e1', 'e4', 'e5', 'e9a', 'e10a', 'e10b', 'e12', 'e13', 'e22', 'e23'];
  highlightCustomPath(heatingEdges, `${zone} Heating`, 'heat');
};

window.callCool = (zone) => {
  const coolingEdges = zone === 'Z1'
    ? ['e1', 'e2', 'e3', 'e7a', 'e8', 'e11', 'e13', 'e14', 'e19', 'e20', 'e21'] 
    : ['e1', 'e4', 'e5', 'e9a', 'e10', 'e11', 'e13', 'e14', 'e22', 'e23'];
  highlightCustomPath(coolingEdges, `${zone} Cooling`, 'cool');
};

window.callAuxHeat = (zone) => {
  const auxEdges = zone === 'Z1'
    ? ['e1', 'e2', 'e3', 'e7a', 'e8b', 'e12a', 'e13', 'e19', 'e20', 'e21'] 
    : ['e1', 'e4', 'e5', 'e9a', 'e10b', 'e12a', 'e13', 'e22', 'e23'];
  highlightCustomPath(auxEdges, `${zone} Aux Heat`, 'aux');
};

window.callDehumidify = (zone) => {
  if (zone === 'Z2') {
    highlightCustomPath(['e1', 'e4', 'e5', 'e15', 'e16', 'e17', 'e18'], 'Z2 Dehumidifier', 'dehumidify');
  }
};

function highlightPath(pathType) {
  const pathMap = {
    power: ['e1', 'e2', 'e3', 'e4', 'e5'],
    cooling: ['e7a', 'e9a', 'e8', 'e10', 'e11', 'e13', 'e14'],
    heating: ['e7a', 'e9a', 'e8a', 'e8b', 'e10a', 'e10b', 'e12', 'e12a', 'e13'],
    dehumidify: ['e15', 'e16', 'e17', 'e18']
  };
  
  const edgeIds = pathMap[pathType] || [];
  highlightCustomPath(edgeIds, pathType);
}

function resetHighlight() {
  window.currentEdges = initialEdges;
  window.currentNodes = initialNodes;
  
  // Update state instead of re-rendering
  if (window.flowSetEdges && window.flowSetNodes) {
    window.flowSetEdges(initialEdges);
    window.flowSetNodes(initialNodes);
  }
  
  // Hide info panel
  showInfoPanel(null);
}

document.getElementById('highlightPower').addEventListener('click', () => highlightPath('power'));
document.getElementById('highlightCooling').addEventListener('click', () => highlightPath('cooling'));
document.getElementById('highlightHeating').addEventListener('click', () => highlightPath('heating'));
document.getElementById('highlightDehumid').addEventListener('click', () => highlightPath('dehumidify'));
document.getElementById('resetBtn').addEventListener('click', resetHighlight);

document.getElementById('toggleEditBtn').addEventListener('click', () => {
  if (window.toggleEditMode) {
    window.toggleEditMode();
    const btn = document.getElementById('toggleEditBtn');
    btn.textContent = btn.textContent.includes('‚úèÔ∏è') ? 'üîí Lock Nodes' : '‚úèÔ∏è Toggle Edit Mode';
  }
});

// Render the app
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(h(Flow));
</script>
</body>
</html>
