<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>HVAC Wiring ‚Äî Svelte Flow Interactive</title>
<style>
:root{
  --bg:#0b1220; --card:#0f1830; --ink:#e8eefc; --muted:#9bb0d6; --accent:#7aa2ff; --good:#6ee7a1; --warn:#fcd34d; --bad:#fca5a5;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
a{color:var(--accent);text-decoration:none}
a:hover{text-decoration:underline}
.container{max-width:1600px;margin:0 auto;padding:32px}
.card{background:var(--card);border:1px solid #223;border-radius:16px;padding:20px;margin:16px 0;box-shadow:0 8px 40px rgba(0,0,0,.35)}
h1{font-size:28px;margin:.2em 0 0.2em}
h2{font-size:22px;margin:1.2em 0 .4em}
.note{color:var(--muted)}
.btn{display:inline-block;background:var(--accent);color:#081020;padding:10px 14px;border-radius:10px;font-weight:600;margin-right:8px}
.controls{
  margin:10px 0;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.controls button{
  background:var(--card);
  color:var(--ink);
  border:1px solid #223;
  padding:8px 12px;
  border-radius:8px;
  cursor:pointer;
  font-size:14px;
}
.controls button:hover{
  background:var(--accent);
  color:#081020;
}
#app {
  width: 100%;
  height: 800px;
  background: #0b1328;
  border: 1px solid #223;
  border-radius: 12px;
  position: relative;
}
</style>
</head>
<body>
<div class="container">
  <h1>HVAC Wiring ‚Äî Svelte Flow Interactive Editor</h1>
  
  <div class="card">
    <h2>Full System Schematic (Svelte Flow)</h2>
    <p class="note">Drag nodes to reposition, zoom with mouse wheel, pan by dragging the canvas. Full interactive editing with automatic edge routing.</p>
    <div class="controls">
      <button onclick="exportLayout()">üíæ Export Layout JSON</button>
      <button onclick="fitView()">üîç Fit View</button>
      <button onclick="toggleMinimap()">üó∫Ô∏è Toggle Minimap</button>
      <button onclick="highlightPath('dehumidify')">Trace Dehumidify Signal</button>
      <button onclick="highlightPath('cooling')">Trace Cooling Call</button>
      <button onclick="highlightPath('heating')">Trace Heating Call</button>
      <button onclick="highlightPath('power')">Show Power Distribution</button>
      <button onclick="resetHighlight()">Reset Highlight</button>
    </div>
    <div id="app"></div>
  </div>

  <p><a class="btn" href="index.html">Back</a> <a class="btn" href="wiring-simple-d3.html">View D3.js Version</a></p>
</div>

<script type="module">
import { SvelteFlow, SvelteFlowProvider, Controls, Background, MiniMap, Position } from 'https://cdn.jsdelivr.net/npm/@xyflow/svelte@0.1.18/+esm';
import { writable } from 'https://cdn.jsdelivr.net/npm/svelte@4.2.8/store/+esm';

// Initialize Svelte Flow in the target div
const app = document.getElementById('app');

// Node types with custom styling
const nodeTypes = {
  transformer: { color: '#9bb0d6', label: '24VAC Transformer' },
  panel: { color: '#7aa2ff', label: 'BMPLUS-3000' },
  thermostat: { color: '#6ee7a1', label: 'Ecobee' },
  relay: { color: '#9bb0d6', label: 'Relay' },
  dehumidifier: { color: '#fcd34d', label: 'Dehumidifier' },
  damper: { color: '#fca5a5', label: 'Damper' },
  equipment: { color: '#9bb0d6', label: 'Equipment' }
};

// Edge colors by type
const edgeColors = {
  hot: '#7aa2ff',
  common: '#6ee7a1',
  signal: '#fcd34d',
  'dry-contact': '#6ee7a1',
  damper: '#fca5a5'
};

// Convert your JSON layout to Svelte Flow nodes
const initialNodes = [
  {
    id: 'transformer',
    type: 'default',
    position: { x: 88.66, y: -124.50 },
    data: { 
      label: '24VAC Transformer\n(UPS-backed)',
      nodeType: 'transformer'
    },
    style: {
      background: nodeTypes.transformer.color,
      color: '#081020',
      border: '2px solid #314',
      borderRadius: '12px',
      padding: '15px',
      fontSize: '13px',
      fontWeight: 'bold',
      width: '140px',
      textAlign: 'center'
    },
    sourcePosition: Position.Right,
    targetPosition: Position.Left
  },
  {
    id: 'panel',
    type: 'default',
    position: { x: 589.71, y: 200.89 },
    data: { 
      label: 'BMPLUS-3000\nZone Panel',
      nodeType: 'panel'
    },
    style: {
      background: nodeTypes.panel.color,
      color: '#081020',
      border: '2px solid #314',
      borderRadius: '12px',
      padding: '20px',
      fontSize: '14px',
      fontWeight: 'bold',
      width: '240px',
      height: '200px',
      textAlign: 'center'
    }
  },
  {
    id: 'ecobeeZ1',
    type: 'default',
    position: { x: 1182.93, y: 30.60 },
    data: { 
      label: 'Ecobee Z1\n(Enhanced)',
      nodeType: 'thermostat'
    },
    style: {
      background: nodeTypes.thermostat.color,
      color: '#081020',
      border: '2px solid #314',
      borderRadius: '12px',
      padding: '15px',
      fontSize: '13px',
      fontWeight: 'bold',
      width: '150px',
      textAlign: 'center'
    }
  },
  {
    id: 'ecobeeZ2',
    type: 'default',
    position: { x: 258.20, y: 423.58 },
    data: { 
      label: 'Ecobee Z2\n(Premium)',
      nodeType: 'thermostat'
    },
    style: {
      background: nodeTypes.thermostat.color,
      color: '#081020',
      border: '2px solid #314',
      borderRadius: '12px',
      padding: '15px',
      fontSize: '13px',
      fontWeight: 'bold',
      width: '150px',
      textAlign: 'center'
    }
  },
  {
    id: 'relay',
    type: 'default',
    position: { x: 807.16, y: 517.62 },
    data: { 
      label: 'RIBU1C\nRelay',
      nodeType: 'relay'
    },
    style: {
      background: nodeTypes.relay.color,
      color: '#081020',
      border: '2px solid #314',
      borderRadius: '12px',
      padding: '15px',
      fontSize: '13px',
      fontWeight: 'bold',
      width: '140px',
      textAlign: 'center'
    }
  },
  {
    id: 'dehumidifier',
    type: 'default',
    position: { x: 1227.93, y: 515.53 },
    data: { 
      label: 'GeneralAire\nDehumidifier',
      nodeType: 'dehumidifier'
    },
    style: {
      background: nodeTypes.dehumidifier.color,
      color: '#081020',
      border: '2px solid #314',
      borderRadius: '12px',
      padding: '15px',
      fontSize: '13px',
      fontWeight: 'bold',
      width: '160px',
      textAlign: 'center'
    }
  },
  {
    id: 'damper1',
    type: 'default',
    position: { x: 608.66, y: -67.03 },
    data: { 
      label: 'Zone 1 Damper\n(First Floor)',
      nodeType: 'damper'
    },
    style: {
      background: nodeTypes.damper.color,
      color: '#081020',
      border: '2px solid #314',
      borderRadius: '12px',
      padding: '15px',
      fontSize: '13px',
      fontWeight: 'bold',
      width: '120px',
      textAlign: 'center'
    }
  },
  {
    id: 'damper2',
    type: 'default',
    position: { x: 708.66, y: 657.48 },
    data: { 
      label: 'Zone 2 Damper\n(Basement)',
      nodeType: 'damper'
    },
    style: {
      background: nodeTypes.damper.color,
      color: '#081020',
      border: '2px solid #314',
      borderRadius: '12px',
      padding: '15px',
      fontSize: '13px',
      fontWeight: 'bold',
      width: '120px',
      textAlign: 'center'
    }
  },
  {
    id: 'equipment',
    type: 'default',
    position: { x: 969.85, y: 631.24 },
    data: { 
      label: 'HVAC Equipment\n(Rheem RP14 + Aux)',
      nodeType: 'equipment'
    },
    style: {
      background: nodeTypes.equipment.color,
      color: '#081020',
      border: '2px solid #314',
      borderRadius: '12px',
      padding: '20px',
      fontSize: '13px',
      fontWeight: 'bold',
      width: '180px',
      textAlign: 'center'
    }
  }
];

// Define edges (connections)
const initialEdges = [
  // Power distribution
  { id: 'e1', source: 'transformer', target: 'panel', label: 'R (24VAC)', type: 'smoothstep', animated: false, style: { stroke: edgeColors.hot, strokeWidth: 3 }, data: { wireType: 'hot', group: 'power' } },
  { id: 'e2', source: 'transformer', target: 'panel', label: 'C (0V)', type: 'smoothstep', animated: false, style: { stroke: edgeColors.common, strokeWidth: 3 }, data: { wireType: 'common', group: 'power' } },
  { id: 'e3', source: 'transformer', target: 'ecobeeZ1', label: 'R', type: 'smoothstep', animated: false, style: { stroke: edgeColors.hot, strokeWidth: 3 }, data: { wireType: 'hot', group: 'power' } },
  { id: 'e4', source: 'transformer', target: 'ecobeeZ1', label: 'C', type: 'smoothstep', animated: false, style: { stroke: edgeColors.common, strokeWidth: 3 }, data: { wireType: 'common', group: 'power' } },
  { id: 'e5', source: 'transformer', target: 'ecobeeZ2', label: 'R', type: 'smoothstep', animated: false, style: { stroke: edgeColors.hot, strokeWidth: 3 }, data: { wireType: 'hot', group: 'power' } },
  { id: 'e6', source: 'transformer', target: 'ecobeeZ2', label: 'C', type: 'smoothstep', animated: false, style: { stroke: edgeColors.common, strokeWidth: 3 }, data: { wireType: 'common', group: 'power' } },
  
  // Ecobee HVAC calls
  { id: 'e7', source: 'ecobeeZ1', target: 'panel', label: 'Y1 (Cool)', type: 'smoothstep', animated: false, style: { stroke: edgeColors.signal, strokeWidth: 2.5 }, data: { wireType: 'signal', group: 'cooling' } },
  { id: 'e8', source: 'ecobeeZ1', target: 'panel', label: 'W1 (Heat)', type: 'smoothstep', animated: false, style: { stroke: edgeColors.signal, strokeWidth: 2.5 }, data: { wireType: 'signal', group: 'heating' } },
  { id: 'e9', source: 'ecobeeZ2', target: 'panel', label: 'Y1 (Cool)', type: 'smoothstep', animated: false, style: { stroke: edgeColors.signal, strokeWidth: 2.5 }, data: { wireType: 'signal', group: 'cooling' } },
  { id: 'e10', source: 'ecobeeZ2', target: 'panel', label: 'W1 (Heat)', type: 'smoothstep', animated: false, style: { stroke: edgeColors.signal, strokeWidth: 2.5 }, data: { wireType: 'signal', group: 'heating' } },
  
  // Panel to equipment
  { id: 'e11', source: 'panel', target: 'equipment', label: 'Y1 (Compressor)', type: 'smoothstep', animated: false, style: { stroke: edgeColors.signal, strokeWidth: 2.5 }, data: { wireType: 'signal', group: 'cooling' } },
  { id: 'e12', source: 'panel', target: 'equipment', label: 'W1 (Aux Heat)', type: 'smoothstep', animated: false, style: { stroke: edgeColors.signal, strokeWidth: 2.5 }, data: { wireType: 'signal', group: 'heating' } },
  { id: 'e13', source: 'panel', target: 'equipment', label: 'G (Fan)', type: 'smoothstep', animated: false, style: { stroke: edgeColors.signal, strokeWidth: 2.5 }, data: { wireType: 'signal', group: 'cooling' } },
  { id: 'e14', source: 'panel', target: 'equipment', label: 'O (Reversing)', type: 'smoothstep', animated: false, style: { stroke: edgeColors.signal, strokeWidth: 2.5 }, data: { wireType: 'signal', group: 'cooling' } },
  
  // Dehumidify path
  { id: 'e15', source: 'ecobeeZ2', target: 'relay', label: 'ACC+ (DH Call)', type: 'smoothstep', animated: false, style: { stroke: edgeColors.signal, strokeWidth: 2.5 }, data: { wireType: 'signal', group: 'dehumidify' } },
  { id: 'e16', source: 'panel', target: 'relay', label: 'C (Common)', type: 'smoothstep', animated: false, style: { stroke: edgeColors.common, strokeWidth: 2.5 }, data: { wireType: 'common', group: 'dehumidify' } },
  { id: 'e17', source: 'relay', target: 'dehumidifier', label: 'D1 (Switched)', type: 'smoothstep', animated: false, style: { stroke: edgeColors['dry-contact'], strokeWidth: 2.5, strokeDasharray: '5,5' }, data: { wireType: 'dry-contact', group: 'dehumidify' } },
  { id: 'e18', source: 'relay', target: 'dehumidifier', label: 'D2 (Switched)', type: 'smoothstep', animated: false, style: { stroke: edgeColors['dry-contact'], strokeWidth: 2.5, strokeDasharray: '5,5' }, data: { wireType: 'dry-contact', group: 'dehumidify' } },
  
  // Zone damper control
  { id: 'e19', source: 'panel', target: 'damper1', label: 'M1 (Common)', type: 'smoothstep', animated: false, style: { stroke: edgeColors.damper, strokeWidth: 2.5 }, data: { wireType: 'damper', group: 'zone1' } },
  { id: 'e20', source: 'panel', target: 'damper1', label: 'M4 (Close)', type: 'smoothstep', animated: false, style: { stroke: edgeColors.damper, strokeWidth: 2.5 }, data: { wireType: 'damper', group: 'zone1' } },
  { id: 'e21', source: 'panel', target: 'damper1', label: 'M6 (Open)', type: 'smoothstep', animated: false, style: { stroke: edgeColors.damper, strokeWidth: 2.5 }, data: { wireType: 'damper', group: 'zone1' } },
  { id: 'e22', source: 'panel', target: 'damper2', label: 'M1 (Common)', type: 'smoothstep', animated: false, style: { stroke: edgeColors.damper, strokeWidth: 2.5 }, data: { wireType: 'damper', group: 'zone2' } },
  { id: 'e23', source: 'panel', target: 'damper2', label: 'M4 (Close)', type: 'smoothstep', animated: false, style: { stroke: edgeColors.damper, strokeWidth: 2.5 }, data: { wireType: 'damper', group: 'zone2' } }
];

// Create Svelte stores
const nodes = writable(initialNodes);
const edges = writable(initialEdges);

// Create the Svelte Flow instance
const flow = new SvelteFlow({
  target: app,
  props: {
    nodes,
    edges,
    fitView: true,
    style: 'background: #0b1328;',
    nodesDraggable: true,
    nodesConnectable: false,
    elementsSelectable: true,
    panOnScroll: false,
    zoomOnScroll: true,
    minZoom: 0.3,
    maxZoom: 2,
    defaultEdgeOptions: {
      type: 'smoothstep'
    }
  }
});

// Global functions for controls
window.exportLayout = function() {
  let currentNodes;
  nodes.subscribe(n => currentNodes = n)();
  
  const layout = {
    components: {},
    edges: initialEdges.map(e => ({
      from: e.source,
      to: e.target,
      type: e.data.wireType,
      group: e.data.group,
      label: e.label
    }))
  };
  
  currentNodes.forEach(node => {
    layout.components[node.id] = {
      x: node.position.x,
      y: node.position.y,
      type: node.data.nodeType,
      label: node.data.label
    };
  });
  
  const json = JSON.stringify(layout, null, 2);
  
  // Download
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'hvac-svelteflow-layout.json';
  a.click();
  URL.revokeObjectURL(url);
  
  console.log("=== Svelte Flow Layout ===");
  console.log(json);
  alert("Layout exported! Check downloads and console.");
};

window.fitView = function() {
  flow.$set({ fitView: true });
};

let minimapVisible = false;
window.toggleMinimap = function() {
  minimapVisible = !minimapVisible;
  // Note: Minimap would require additional setup with Svelte Flow components
  alert("Minimap toggle - would require full Svelte component setup");
};

window.highlightPath = function(group) {
  edges.update(edgeList => {
    return edgeList.map(edge => {
      if (edge.data.group === group) {
        return {
          ...edge,
          animated: true,
          style: { ...edge.style, strokeWidth: 5, stroke: '#fcd34d' }
        };
      } else {
        return {
          ...edge,
          style: { ...edge.style, opacity: 0.2 }
        };
      }
    });
  });
  
  nodes.update(nodeList => {
    // Get nodes involved in this group
    let relevantNodes = new Set();
    initialEdges.forEach(edge => {
      if (edge.data.group === group) {
        relevantNodes.add(edge.source);
        relevantNodes.add(edge.target);
      }
    });
    
    return nodeList.map(node => {
      if (relevantNodes.has(node.id)) {
        return node;
      } else {
        return {
          ...node,
          style: { ...node.style, opacity: 0.3 }
        };
      }
    });
  });
};

window.resetHighlight = function() {
  edges.set(initialEdges);
  nodes.update(nodeList => {
    return nodeList.map(node => {
      return {
        ...node,
        style: { ...node.style, opacity: 1 }
      };
    });
  });
};
</script>
</body>
</html>
